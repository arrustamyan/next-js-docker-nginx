# Jamstack website example using Docker, nginx, next.js

This is a Jamstack website example using [`Docker`](https://www.docker.com/), [`Next.js`](https://nextjs.org/) and [`nginx`](https://nginx.org/).

## Setup

Let's go over the setup step-by-step.

### Docker

Dockerfile included in the project contains instructions for building the Next.js project and packaging it as a nginx container. Build process is split between two stages:

- using `node:18.19-alpine` base image for building the Next.js project,
- using latest `nginx:alpine` base image for serving static assets generated by the previous state.

More on multi-stage builds [here](https://docs.docker.com/build/building/multi-stage/).

Build process heavily utilizes [Docker build cache](https://docs.docker.com/build/cache/) to avoid rebuilding layers for unmodified files.

For details refer to comments in [`Dockerfile`](Dockerfile).

> Note! `alpine` is a 5MB linux distro optimized for usage as a base image. It drastically reduces amount of MBs downloaded during build process. However this comes with certain drawbacks. You can read more about it [here](https://techforyou.medium.com/why-i-will-never-use-alpine-linux-ever-again-c347b3bd379c).

### docker-compose

`docker-compose` is a tool for defining and running multi-container applications. It is often used in dev environments to avoid writing `docker run ...` commands and simplifies network creation and volume mounting among other things. It comes prebundled with Docker, so there is no need to install it separately.

`docker-compose.yml` file included in the project contains instructions for building the container, exposing port `80` and mounting two volumes: nginx server configuration and Next.js build files. Instruction for running the app using docker-compose are provided below.

For details refer to comments in [`docker-compose.yml`](docker-compose.yml)

### nginx

There are various ways to host Jamstack websites, but when considering **dockerized** environments, `nginx` is a [popular choice](https://adamjones.me/blog/benchmark-next-vs-nginx/). In our case we are configuring a web server that serves generated static files and handles compression, error pages and caching.

See comments in [`server.conf`](nginx/server.conf) for details.

**A few assumptions behind current nginx setup:**

- **HTTPS** - although nginx can be configured to serve HTTPS traffic, this function is usually delegated to a cloud native tool like CloudFlare, AWS CloudFront, etc.
- **compression** - to reduce the amount bytes transferred over the wire it is advised to use effective compression algorithms. nginx comes with [built-in support of `gzip`](https://nginx.org/en/docs/http/ngx_http_gzip_module.html), however Brotli is something to be considered as well.
- **Security** - in production environment additional configuration is required to make sure the website adheres to security best practices, such as enabling CORS, CSP, etc.

### Environment variables

## next.js

The next.js project is bootstrapped with [`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app) as it comes with sensible defaults.

### Running Next.js development server

Running the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

### Running the production build with `docker-compose`

To test the website locally in a production like environment build the website and launch the docker container:

```sh
# Generate the static assets
npm run build

# Run the docker container using docker-compose
docker-compose up
```

Open [http://localhost](http://localhost) with your browser to see the result.

To make subsequent changes simply run `npm run build` and refresh the browser. No need to restart the Docker container.

If you made changes to `package.json`, however, you need to rebuild the container:

```sh
# This ensures node modules are updated inside the container
docker-compose up --build
```

### Data

Data is hosted on Storyblok.
